// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ADMIN
  MODERATOR
  EDITOR
  AUTHOR
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubjectType {
  ACADEMIC
  TECHNICAL
  CREATIVE
  BUSINESS
  OTHER
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum CourseStatus {
  DRAFT
  LIVE
  ARCHIVED
  COMING_SOON
}

enum ChatSender {
  USER
  AI
}

enum SessionStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum QuestionLevel {
  EASY
  MEDIUM
  HARD
  ADVANCE
}

enum QuestionType {
  TRUE_FALSE
  MCQ_SINGLE
  MCQ_MULTIPLE
  FILL_BLANK
  MIXED
}

enum AssessmentStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum QuestionStatus {
  DRAFT
  LIVE
  INACTIVE
  ARCHIVED
}

enum ProgressStatus {
  NOT_STARTED
  STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
  ABANDONED
}

enum PlanStatus {
  ACTIVE
  INACTIVE
}

enum UserPlanStatus {
  ACTIVE
  PENDING
  CANCELLED
  EXPIRED
}

enum PlanFeatureStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum NoteStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  DELETED
}

// Core Models
model User {
  id                String         @id @default(cuid())
  clerkUserId       String?        @unique @map("clerk_user_id")
  email             String         @unique
  name              String?
  imageUrl          String?        @map("image_url")
  role              UserRole       @default(USER)
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  blogContents      BlogContent[]
  blogs             Blog[]
  chatSessions      ChatSession[]
  blogProgress      BlogProgress[]
  chapterProgress   ChapterProgress[]
  courseProgress    CourseProgress[]
  assessments       Assessment[]
  userPreferences   UserPreference[]
  userPlans         UserPlan[]
  userNotes         UserNote[]
}

model UserNote {
  id            String     @id @default(cuid())
  userId        String     @map("user_id")
  noteTitle     String     @map("note_title")
  noteContent   String     @map("note_content")
  status        NoteStatus @default(ACTIVE)
  lastOpenedAt  DateTime   @default(now()) @map("last_opened_at") @db.Timestamptz
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  
  // Relations
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BlogContent {
  id                String         @id @default(cuid())
  name              String
  slug              String         @unique
  textContent       String         @map("text_content")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  createdBy         User           @relation(fields: [createdById], references: [id])
  createdById       String         @map("created_by_id")
  sequences         BlogSequence[]
}

model Blog {
  id                              String         @id @default(cuid())
  title                           String
  slug                            String         @unique
  tags                            String[]
  readingTime                     Int            @default(5) @map("reading_time") // Reading time in minutes
  publishedAt                     DateTime?      @map("published_at") @db.Timestamptz
  status                          BlogStatus     @default(DRAFT)
  meta                            Json           @default("{}")
  createdAt                       DateTime       @default(now()) @db.Timestamptz
  updatedAt                       DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  author                          User           @relation(fields: [authorId], references: [id])
  authorId                        String         @map("author_id")
  categories                      BlogCategory[]
  sequences                       BlogSequence[]
  chapterTopicRelations           ChapterTopicRelation[]
  chatSessions                    ChatSession[]
  blogProgress                    BlogProgress[]
  questions                       Question[]
  assessments                     Assessment[]
}

model BlogMedia {
  id                String         @id @default(cuid())
  name              String
  slug              String         @unique
  mediaType         MediaType      @map("media_type")
  mediaUrl          String         @map("media_url")
  description       String?
  meta              Json           @default("{}")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  sequences         BlogSequence[]
}

model Category {
  id                String         @id @default(cuid())
  name              String         @unique
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  blogs             BlogCategory[]
}

model Course {
  id                String         @id @default(cuid())
  name              String
  description       String
  subjectType       SubjectType    @map("subject_type")
  status            CourseStatus   @default(DRAFT)
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  chapterTopics     ChapterTopic[]
  chatSessions      ChatSession[]
  courseProgress    CourseProgress[]
  questions         Question[]
  assessments       Assessment[]
}

model ChapterTopic {
  id                String         @id @default(cuid())
  courseId          String         @map("course_id")
  sequenceNumber    Int            @map("sequence_number")
  name              String
  description       String
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  blogRelations     ChapterTopicRelation[]
  chatSessions      ChatSession[]
  blogProgress      BlogProgress[]
  chapterProgress   ChapterProgress[]
  questions         Question[]
  assessments       Assessment[]
  
  // Constraints
  @@unique([courseId, sequenceNumber])
}

// Junction table for Blog-Category many-to-many relationship
model BlogCategory {
  id                String         @id @default(cuid())
  blogId            String         @map("blog_id")
  categoryId        String         @map("category_id")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  
  // Relations
  blog              Blog           @relation(fields: [blogId], references: [id], onDelete: Cascade)
  category          Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([blogId, categoryId])
}

// Junction table for ChapterTopic-Blog many-to-many relationship
model ChapterTopicRelation {
  id                String         @id @default(cuid())
  chapterTopicId    String         @map("chapter_topic_id")
  blogId            String         @map("blog_id")
  sequence          Int            // Position/sequence number
  createdAt         DateTime       @default(now()) @db.Timestamptz
  
  // Relations
  chapterTopic      ChapterTopic   @relation(fields: [chapterTopicId], references: [id], onDelete: Cascade)
  blog              Blog           @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([chapterTopicId, blogId])
  @@unique([chapterTopicId, sequence])
}

// Unified table for Blog sequences (content and media)
model BlogSequence {
  id                String         @id @default(cuid())
  blogId            String         @map("blog_id")
  sequence          Int            // Position/sequence number
  
  // Either content OR media, but not both
  blogContentId     String?        @map("blog_content_id")
  blogMediaId       String?        @map("blog_media_id")
  
  createdAt         DateTime       @default(now()) @db.Timestamptz
  
  // Relations
  blog              Blog           @relation(fields: [blogId], references: [id], onDelete: Cascade)
  blogContent       BlogContent?   @relation(fields: [blogContentId], references: [id], onDelete: Cascade)
  blogMedia         BlogMedia?     @relation(fields: [blogMediaId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([blogId, sequence])
  @@index([blogId, blogContentId])
  @@index([blogId, blogMediaId])
}

// Chat Models
model ChatSession {
  id                String         @id @default(cuid())
  userId            String         @map("user_id")
  sessionName       String?        @map("session_name")
  blogId            String?        @map("blog_id")
  courseId          String?        @map("course_id")
  chapterTopicId    String?        @map("chapter_topic_id")
  status            SessionStatus  @default(ACTIVE)
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog              Blog?          @relation(fields: [blogId], references: [id], onDelete: Cascade)
  course            Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapterTopic      ChapterTopic?  @relation(fields: [chapterTopicId], references: [id], onDelete: Cascade)
  messages          ChatMessage[]
  
  // Indexes
  @@index([userId])
  @@index([blogId])
  @@index([courseId])
  @@index([chapterTopicId])
}

model ChatMessage {
  id                String         @id @default(cuid())
  sessionId         String         @map("session_id")
  message           String
  sender            ChatSender
  createdAt         DateTime       @default(now()) @db.Timestamptz
  
  // Relations
  session           ChatSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([sessionId])
  @@index([createdAt])
}

// Progress Tracking Models
model BlogProgress {
  id                String         @id @default(cuid())
  blogId            String         @map("blog_id")
  chapterId         String         @map("chapter_id")
  userId            String         @map("user_id")
  status            ProgressStatus @default(NOT_STARTED)
  completedAt       DateTime?      @map("completed_at") @db.Timestamptz
  startedAt         DateTime?      @map("started_at") @db.Timestamptz
  lastAccessedAt    DateTime?      @map("last_accessed_at") @db.Timestamptz
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  blog              Blog           @relation(fields: [blogId], references: [id], onDelete: Cascade)
  chapterTopic      ChapterTopic   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapterProgress   ChapterProgress @relation(fields: [chapterId, userId], references: [chapterId, userId])
  
  // Constraints
  @@unique([userId, blogId])
  @@index([chapterId])
  @@index([userId])
  @@index([status])
}

model ChapterProgress {
  id                String         @id @default(cuid())
  chapterId         String         @map("chapter_id")
  userId            String         @map("user_id")
  status            ProgressStatus @default(NOT_STARTED)
  completedAt       DateTime?      @map("completed_at") @db.Timestamptz
  startedAt         DateTime?      @map("started_at") @db.Timestamptz
  lastAccessedAt    DateTime?      @map("last_accessed_at") @db.Timestamptz
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  chapterTopic      ChapterTopic   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  blogProgress      BlogProgress[]
  
  // Constraints
  @@unique([userId, chapterId])
  @@index([userId])
  @@index([status])
}

model CourseProgress {
  id                String         @id @default(cuid())
  courseId          String         @map("course_id")
  userId            String         @map("user_id")
  status            ProgressStatus @default(NOT_STARTED)
  completedAt       DateTime?      @map("completed_at") @db.Timestamptz
  startedAt         DateTime?      @map("started_at") @db.Timestamptz
  lastAccessedAt    DateTime?      @map("last_accessed_at") @db.Timestamptz
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  course            Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([userId, courseId])
  @@index([userId])
  @@index([status])
}

// Quiz Models
model Question {
  id              String        @id @default(cuid())
  text            String
  options         Json?         // For MCQs, matching etc. Keep as JSON: {a: "...", b: "..."}
  correctAnswers  Json?         // Can store ["a", "c"] for MCQ multiple
  explanation     String?
  level           QuestionLevel
  type            QuestionType
  status          QuestionStatus @default(LIVE)
  blogId          String?       @map("blog_id")
  chapterTopicId  String?       @map("chapter_topic_id")
  courseId        String?       @map("course_id")
  createdAt       DateTime      @default(now()) @db.Timestamptz
  updatedAt       DateTime      @updatedAt @db.Timestamptz
  
  // Relations
  blog            Blog?         @relation(fields: [blogId], references: [id], onDelete: Cascade)
  chapterTopic    ChapterTopic? @relation(fields: [chapterTopicId], references: [id], onDelete: Cascade)
  course          Course?       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assessmentQuestions AssessmentQuestion[]
  
  // Indexes
  @@index([blogId])
  @@index([chapterTopicId])
  @@index([courseId])
  @@index([level])
  @@index([type])
  @@index([status])
}

model Assessment {
  id              String          @id @default(cuid())
  userId          String          @map("user_id")
  title           String?
  description     String?
  level           QuestionLevel
  allowedTypes    QuestionType[]  // what user selected for this quiz
  totalQuestions  Int
  status          AssessmentStatus @default(DRAFT)
  blogId          String?         @map("blog_id")
  chapterTopicId  String?         @map("chapter_topic_id")
  courseId        String?         @map("course_id")
  createdAt       DateTime        @default(now()) @db.Timestamptz
  updatedAt       DateTime        @updatedAt @db.Timestamptz
  
  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog            Blog?           @relation(fields: [blogId], references: [id], onDelete: Cascade)
  chapterTopic    ChapterTopic?   @relation(fields: [chapterTopicId], references: [id], onDelete: Cascade)
  course          Course?         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assessmentQuestions AssessmentQuestion[]
  feedback        AssessmentFeedback?
  
  // Indexes
  @@index([userId])
  @@index([blogId])
  @@index([chapterTopicId])
  @@index([courseId])
  @@index([status])
}

model AssessmentQuestion {
  id             String     @id @default(cuid())
  assessmentId   String     @map("assessment_id")
  questionId     String     @map("question_id")
  sequence       Int        // order of question in quiz
  userAnswer     Json?      // track answer if attempted
  isCorrect      Boolean?
  createdAt      DateTime   @default(now()) @db.Timestamptz
  updatedAt      DateTime   @updatedAt @db.Timestamptz
  
  // Relations
  assessment     Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question       Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([assessmentId, questionId])
  @@unique([assessmentId, sequence])
  @@index([assessmentId])
  @@index([questionId])
}

model AssessmentFeedback {
  id                String         @id @default(cuid())
  assessmentId      String         @unique @map("assessment_id")
  rawResponse       Json           @map("raw_response") // Raw AI response in JSON format
  overallSummary    String         @map("overall_summary") // Text summary of the feedback
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  
  // Relations
  assessment        Assessment     @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
}

model UserPreference {
  id             String     @id @default(cuid())
  level          QuestionLevel
  allowedTypes   QuestionType[]  
  totalQuestions Int
  userId         String     @map("user_id")
  createdAt      DateTime   @default(now()) @db.Timestamptz
  updatedAt      DateTime   @updatedAt @db.Timestamptz
  
  // Relations
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([userId])
  @@index([userId])
}

// Subscription and Plan Models
model Plan {
  id                String         @id @default(cuid())
  name              String         @map("name")
  description       String         @map("description")
  price_per_month   Int            @map("price_per_month")
  status            PlanStatus     @map("status")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  features          PlanFeature[]
  userPlans         UserPlan[]
}

model PlanFeature {
  id                String         @id @default(cuid())
  planId            String         @map("plan_id")
  feature           String         @map("feature")
  description       String         @map("description")
  featureSlug       String         @map("feature_slug")
  status            PlanFeatureStatus @default(ACTIVE) @map("status")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  plan              Plan           @relation(fields: [planId], references: [id])
}

model Discount {
  id                String         @id @default(cuid())
  discountCode      String         @map("discount_code")
  discountAmount    Int            @map("discount_amount")
  description       String         @map("description")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  userPlans         UserPlan[]
}

model UserPlan {
  id                String         @id @default(cuid())
  userId            String         @map("user_id")
  planId            String         @map("plan_id")
  duration          Int            @map("duration")
  startDate         DateTime       @map("start_date")
  endDate           DateTime       @map("end_date")
  status            UserPlanStatus @map("status")
  discountId        String?        @map("discount_id")
  paidAmount        Int            @map("paid_amount")
  orderId           String         @map("order_id")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz

  plan              Plan           @relation(fields: [planId], references: [id])
  user              User           @relation(fields: [userId], references: [id])
  discount          Discount?      @relation(fields: [discountId], references: [id])
  payments          UserPlanPayment[]
}

model UserPlanPayment {
  id                String         @id @default(cuid())
  userPlanId        String         @map("user_plan_id")
  orderId           String         @map("order_id")
  paymentId         String         @map("payment_id")
  status            PaymentStatus @default(PENDING)
  paymentDetails    Json?          @map("payment_details")
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz

  userPlan          UserPlan       @relation(fields: [userPlanId], references: [id], onDelete: Cascade)
}